import{$ as N}from"./index-D167PO3o.js";var G=Object.defineProperty,I=(y,t,s)=>t in y?G(y,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):y[t]=s,a=(y,t,s)=>I(y,typeof t!="symbol"?t+"":t,s);class W{constructor(){a(this,"a0",1),a(this,"a1",0),a(this,"a2",0),a(this,"b0",1),a(this,"b1",0),a(this,"b2",0),a(this,"x1",0),a(this,"x2",0),a(this,"y1",0),a(this,"y2",0)}bandpass(t,s,n){const i=2*Math.PI*t/n,c=t/s,l=Math.sin(i)/(2*c);this.b0=l,this.b1=0,this.b2=-l,this.a0=1+l,this.a1=-2*Math.cos(i),this.a2=1-l,this.b0/=this.a0,this.b1/=this.a0,this.b2/=this.a0,this.a1/=this.a0,this.a2/=this.a0}process(t){const s=this.b0*t+this.b1*this.x1+this.b2*this.x2-this.a1*this.y1-this.a2*this.y2;return this.x2=this.x1,this.x1=t,this.y2=this.y1,this.y1=s,s}reset(){this.x1=0,this.x2=0,this.y1=0,this.y2=0}filtfilt(t){if(t.length===0)return[];this.reset();const s=new Array(t.length);for(let i=0;i<t.length;i++)s[i]=this.process(t[i]);this.reset();const n=new Array(t.length);for(let i=t.length-1;i>=0;i--)n[i]=this.process(s[i]);return n.reverse()}}class H{constructor(t){a(this,"config",{earlyEstimation:!1,minDuration:10,minConfidence:.6,debug:!1}),a(this,"estimation_",null),a(this,"signalBuffer",[]),a(this,"timestamps",[]),a(this,"maxBufferSize",450),a(this,"minSamplesForEstimation",150),a(this,"currentPulseRate",0),a(this,"onPulseRateUpdate"),a(this,"timeWindow",10),a(this,"stride",1),a(this,"lb",50),a(this,"ub",140),a(this,"hrRes",1),t&&this.configure(t)}log(t,...s){this.config.debug&&console.log(`[FdaRealtimeEstimator] ${t}`,...s)}get estimation(){return this.estimation_}get signalData(){return this.signalBuffer.length===0?null:{values:[...this.signalBuffer],timestamps:[...this.timestamps],sampleRate:this.getSampleRate()}}configure(t){t&&(this.config={...this.config,...t})}processFrame(t,s,n,i){s!==N.Idle&&(!i||!i.face||this.processFrameAsync(t,i.face))}async processFrameAsync(t,s){const n=await this.extractRealPPGSignal(t,s);n!==null&&(this.signalBuffer.push(n),this.timestamps.push(Date.now()),this.signalBuffer.length>this.maxBufferSize&&(this.signalBuffer.shift(),this.timestamps.shift()),this.signalBuffer.length>=this.minSamplesForEstimation&&this.processSignal())}async extractRealPPGSignal(t,s){try{const n=await s.imageData;if(!n)return null;const i=n.data;let c=0,l=0,f=0;for(let r=0;r<i.length;r+=4)c+=i[r+1],l+=i[r+2],f++;if(f===0)return null;const g=c/f,d=l/f;return d<1?g:g/d}catch(n){return console.warn("Failed to extract PPG signal:",n),null}}getSampleRate(){if(this.timestamps.length<2)return 30;const t=this.timestamps[this.timestamps.length-1]-this.timestamps[0];return(this.timestamps.length-1)*1e3/t}processSignal(){var t;try{const s=this.getSampleRate();let n=[...this.signalBuffer];const i=n.reduce((u,R)=>u+R,0)/n.length;n=n.map(u=>u-i);const c=Math.max(...n.map(Math.abs));c>0&&(n=n.map(u=>u/c));const l=(this.lb-10)/60,f=(this.ub+10)/60,g=(l+f)/2,d=f-l,r=new W;r.bandpass(g,d,s);const o=r.filtfilt(n),m=this.getHeartRate(o,s);if(m&&m.heartRate>0){const u=m.heartRate,R=this.calculateSNR(o),M=Math.min(Math.max(R/10,0),1),x=M>.3;this.estimation_={heartRate:u,confidence:M,isStable:x,snr:R,signalQuality:M*100},this.currentPulseRate=u,(t=this.onPulseRateUpdate)==null||t.call(this,this.currentPulseRate),this.log(`Estimated HR: ${u.toFixed(1)} BPM, SNR: ${R.toFixed(2)}`)}}catch(s){console.warn("Failed to process signal:",s)}}getHeartRate(t,s){const n=this.timeWindow,i=this.stride,c=this.lb,l=this.ub,f=this.hrRes,g=Math.round(n*s),d=Math.round(i*s);if(t.length<g)return null;const r=[];for(let e=0;e<=t.length-g;e+=d)r.push(e);if(r.length===0)return null;const o=[];for(let e=c;e<=l;e+=f)o.push(e);const m=o.map(e=>e/60);for(let e=0;e<t.length;e++);const u=[];for(let e=0;e<m.length;e++)u.push(new Array(r.length).fill(0));for(let e=0;e<r.length;e++){const p=r[e],b=p+g;for(let h=0;h<m.length;h++){const E=m[h];let P=0,S=0;for(let w=p;w<b;w++){const D=(w+1)/s,F=-2*Math.PI*E*D,A=t[w];P+=A*Math.cos(F),S+=A*Math.sin(F)}P/=s,S/=s;const _=P*P+S*S;u[h][e]=_}}for(let e=0;e<r.length;e++){let p=0;for(let h=0;h<m.length;h++)p+=u[h][e];const b=p/m.length;if(b>0)for(let h=0;h<m.length;h++)u[h][e]/=b}const R=Math.round(6/f)+1,M=new Array(R).fill(1/R),x=[];for(let e=0;e<m.length;e++)x.push(new Array(r.length).fill(0));for(let e=0;e<r.length;e++){const p=u.map(h=>h[e]),b=this.convolve(p,M);for(let h=0;h<m.length;h++)x[h][e]=b[h]}const v=[];for(let e=0;e<r.length;e++){let p=-1,b=-1;for(let h=0;h<m.length;h++)x[h][e]>p&&(p=x[h][e],b=h);v.push(o[b])}const B=v.filter(e=>!isNaN(e));return B.length===0?null:{heartRate:B.reduce((e,p)=>e+p,0)/B.length,heartRatePerWindow:v}}convolve(t,s){const n=new Array(t.length).fill(0),i=s.length,c=Math.floor(i/2);for(let l=0;l<t.length;l++){let f=0;for(let g=0;g<i;g++){const d=l-c+g;let r=0;if(d>=0&&d<t.length)r=t[d];else{let o=d;for(;o<0||o>=t.length;)o<0&&(o=-o),o>=t.length&&(o=2*t.length-2-o);r=t[o]}f+=r*s[i-1-g]}n[l]=f}return n}calculateSNR(t){if(t.length===0)return 0;const s=t.reduce((c,l)=>c+l,0)/t.length,n=t.reduce((c,l)=>c+Math.pow(l-s,2),0)/t.length,i=Math.sqrt(n);return(Math.max(...t)-Math.min(...t))/(i+1e-4)}updateWithServerResult(t,s,n){var i;this.estimation_={heartRate:Math.round(t),confidence:1,isStable:!0,snr:s,signalQuality:n},this.currentPulseRate=Math.round(t),(i=this.onPulseRateUpdate)==null||i.call(this,this.currentPulseRate)}reset(){this.estimation_=null,this.signalBuffer=[],this.timestamps=[],this.currentPulseRate=0}}export{H as FdaRealtimeEstimator};

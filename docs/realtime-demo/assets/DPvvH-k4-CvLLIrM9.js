import{U as d,x as u}from"./index-bB6-Pi5A.js";var g=Object.defineProperty,f=(l,t,s)=>t in l?g(l,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):l[t]=s,i=(l,t,s)=>f(l,typeof t!="symbol"?t+"":t,s);class w{constructor(t){i(this,"config",{earlyEstimation:!1,minDuration:10,minConfidence:.6,debug:!1}),i(this,"estimation_",null),i(this,"signalBuffer",[]),i(this,"timestamps",[]),i(this,"maxBufferSize",450),i(this,"currentPulseRate",0),i(this,"onPulseRateUpdate"),i(this,"wasmModule",null),i(this,"wasmCore",null),i(this,"wasmLoadPromise",null),i(this,"maxProcessFrameRate",30),i(this,"minProcessInterval",1e3/this.maxProcessFrameRate),i(this,"processTimer",null),i(this,"pendingFrame",null),i(this,"isProcessing",!1),t&&this.configure(t)}log(t,...s){this.config.debug&&console.log(`[FdaRealtimeEstimator] ${t}`,...s)}resolveModelPath(t){return t.startsWith("http")||t.startsWith("/")||!d.loadModelsFromRoot?t:`/${t}`}async ensureWasmLoaded(){if(!(this.wasmModule&&this.wasmCore))return this.wasmLoadPromise?this.wasmLoadPromise:(this.wasmLoadPromise=(async()=>{try{this.log("Loading WASM module..."),this.config.debug&&console.log("[FdaRealtimeEstimator] Starting WASM import...");const t=this.resolveModelPath("models/fda/fda-estimator.js");this.config.debug&&console.log("[FdaRealtimeEstimator] Loading script from:",t),await new Promise((s,a)=>{const e=document.createElement("script");e.src=t,e.onload=()=>{if(this.config.debug&&console.log("[FdaRealtimeEstimator] Script loaded successfully"),typeof window.createFdaEstimator=="function"){const o=window.createFdaEstimator;o({locateFile:r=>(this.config.debug&&console.log("[FdaRealtimeEstimator] locateFile called for:",r),r.endsWith(".wasm")?this.resolveModelPath("models/fda/fda-estimator.wasm"):r)}).then(r=>{this.wasmModule=r,this.config.debug&&console.log("[FdaRealtimeEstimator] WASM loaded via script tag"),s()}).catch(r=>{this.config.debug&&console.error("[FdaRealtimeEstimator] Failed to initialize WASM module:",r),a(r)})}else a(new Error("createFdaEstimator function not found after script load"))},e.onerror=()=>a(new Error("Failed to load WASM script")),document.head.appendChild(e)}),this.config.debug&&(console.log("[FdaRealtimeEstimator] WASM module instance:",this.wasmModule),console.log("[FdaRealtimeEstimator] Module instance keys:",Object.keys(this.wasmModule||{}))),this.wasmModule&&(this.wasmCore=new this.wasmModule.FdaEstimatorCore,this.config.debug&&console.log("[FdaRealtimeEstimator] WASM core created:",this.wasmCore)),this.log("WASM module loaded successfully")}catch(t){throw this.config.debug&&console.error("[FdaRealtimeEstimator] Failed to load WASM module:",t),t}})(),this.wasmLoadPromise)}get estimation(){return this.estimation_}get signalData(){return this.signalBuffer.length===0?null:{values:[...this.signalBuffer],timestamps:[...this.timestamps],sampleRate:this.getSampleRate()}}configure(t){t&&(this.config={...this.config,...t})}processFrame(t,s,a,e){s!==u.Idle&&(!e||!e.face||(this.pendingFrame={videoFrame:t,roi:e.face},this.processTimer===null&&!this.isProcessing&&this.startProcessTimer()))}startProcessTimer(){this.processTimer=window.setInterval(()=>{if(!this.isProcessing&&this.pendingFrame){const t=this.pendingFrame;this.pendingFrame=null,this.isProcessing=!0,this.processFrameAsync(t.videoFrame,t.roi).finally(()=>{this.isProcessing=!1})}},this.minProcessInterval)}async processFrameAsync(t,s){var a;try{await this.ensureWasmLoaded();const e=await this.extractRealPPGSignal(t,s);if(e!==null&&this.wasmCore&&(this.signalBuffer.push(e),this.timestamps.push(Date.now()),this.signalBuffer.length>this.maxBufferSize&&(this.signalBuffer.shift(),this.timestamps.shift()),this.wasmCore.addSample(e,Date.now()),this.wasmCore.hasEnoughData())){const o=this.wasmCore.processSignal();o.heartRate>0&&(this.estimation_={heartRate:o.heartRate,confidence:o.confidence,isStable:o.isStable,snr:o.snr,signalQuality:o.confidence*100},this.currentPulseRate=o.heartRate,(a=this.onPulseRateUpdate)==null||a.call(this,this.currentPulseRate),this.log(`Estimated HR: ${o.heartRate.toFixed(1)} BPM, SNR: ${o.snr.toFixed(2)}`))}}catch(e){this.config.debug&&console.warn("Failed to process frame:",e)}}async extractRealPPGSignal(t,s){try{const a=await s.imageData;if(!a)return null;const e=a.data;let o=0,r=0,n=0;for(let m=0;m<e.length;m+=4)o+=e[m+1],r+=e[m+2],n++;if(n===0)return null;const h=o/n,c=r/n;return c<1?h:h/c}catch(a){return this.config.debug&&console.warn("Failed to extract PPG signal:",a),null}}getSampleRate(){if(this.timestamps.length<2)return 30;const t=this.timestamps[this.timestamps.length-1]-this.timestamps[0];return(this.timestamps.length-1)*1e3/t}updateWithServerResult(t,s,a){var e;this.estimation_={heartRate:Math.round(t),confidence:1,isStable:!0,snr:s,signalQuality:a},this.currentPulseRate=Math.round(t),(e=this.onPulseRateUpdate)==null||e.call(this,this.currentPulseRate)}reset(){this.estimation_=null,this.signalBuffer=[],this.timestamps=[],this.currentPulseRate=0,this.pendingFrame=null,this.isProcessing=!1,this.processTimer!==null&&(clearInterval(this.processTimer),this.processTimer=null),this.wasmCore&&this.wasmCore.reset()}dispose(){this.processTimer&&clearInterval(this.processTimer)}}export{w as FdaRealtimeEstimator};

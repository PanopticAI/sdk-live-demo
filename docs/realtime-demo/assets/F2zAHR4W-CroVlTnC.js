import{$ as G}from"./index-DOtz5fIo.js";var I=Object.defineProperty,H=(y,t,s)=>t in y?I(y,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):y[t]=s,h=(y,t,s)=>H(y,typeof t!="symbol"?t+"":t,s);class U{constructor(){h(this,"a0",1),h(this,"a1",0),h(this,"a2",0),h(this,"b0",1),h(this,"b1",0),h(this,"b2",0),h(this,"x1",0),h(this,"x2",0),h(this,"y1",0),h(this,"y2",0)}bandpass(t,s,n){const i=2*Math.PI*t/n,u=t/s,l=Math.sin(i)/(2*u);this.b0=l,this.b1=0,this.b2=-l,this.a0=1+l,this.a1=-2*Math.cos(i),this.a2=1-l,this.b0/=this.a0,this.b1/=this.a0,this.b2/=this.a0,this.a1/=this.a0,this.a2/=this.a0}process(t){const s=this.b0*t+this.b1*this.x1+this.b2*this.x2-this.a1*this.y1-this.a2*this.y2;return this.x2=this.x1,this.x1=t,this.y2=this.y1,this.y1=s,s}reset(){this.x1=0,this.x2=0,this.y1=0,this.y2=0}filtfilt(t){if(t.length===0)return[];this.reset();const s=new Array(t.length);for(let i=0;i<t.length;i++)s[i]=this.process(t[i]);this.reset();const n=new Array(t.length);for(let i=t.length-1;i>=0;i--)n[i]=this.process(s[i]);return n.reverse()}}class q{constructor(t){h(this,"config",{earlyEstimation:!1,minDuration:10,minConfidence:.6,debug:!1}),h(this,"estimation_",null),h(this,"signalBuffer",[]),h(this,"timestamps",[]),h(this,"maxBufferSize",450),h(this,"minSamplesForEstimation",150),h(this,"currentPulseRate",0),h(this,"onPulseRateUpdate"),h(this,"timeWindow",10),h(this,"stride",1),h(this,"lb",50),h(this,"ub",140),h(this,"hrRes",1),t&&this.configure(t)}log(t,...s){this.config.debug&&console.log(`[FdaRealtimeEstimator] ${t}`,...s)}get estimation(){return this.estimation_}get signalData(){return this.signalBuffer.length===0?null:{values:[...this.signalBuffer],timestamps:[...this.timestamps],sampleRate:this.getSampleRate()}}configure(t){t&&(this.config={...this.config,...t})}processFrame(t,s,n,i){s!==G.Idle&&(!i||!i.face||this.processFrameAsync(t,i.face))}async processFrameAsync(t,s){const n=await this.extractRealPPGSignal(t,s);n!==null&&(this.signalBuffer.push(n),this.timestamps.push(Date.now()),this.signalBuffer.length>this.maxBufferSize&&(this.signalBuffer.shift(),this.timestamps.shift()),this.signalBuffer.length>=this.minSamplesForEstimation&&this.processSignal())}async extractRealPPGSignal(t,s){try{const n=await s.imageData;if(!n)return null;const i=n.data;let u=0,l=0,g=0;for(let c=0;c<i.length;c+=4)u+=i[c+1],l+=i[c+2],g++;if(g===0)return null;const p=u/g,d=l/g;return d<1?p:p/d}catch(n){return console.warn("Failed to extract PPG signal:",n),null}}getSampleRate(){if(this.timestamps.length<2)return 30;const t=this.timestamps[this.timestamps.length-1]-this.timestamps[0];return(this.timestamps.length-1)*1e3/t}processSignal(){var t;try{const s=this.getSampleRate();let n=[...this.signalBuffer];const i=n.reduce((r,b)=>r+b,0)/n.length;n=n.map(r=>r-i);const u=Math.max(...n.map(Math.abs));u>0&&(n=n.map(r=>r/u));const l=(this.lb-10)/60,g=(this.ub+10)/60,p=(l+g)/2,d=g-l,c=new U;c.bandpass(p,d,s);const o=c.filtfilt(n),x=this.getHeartRate(o,s);if(x&&x.heartRate>0){const r=x.heartRate,b=this.calculateSNR(o),f=Math.min(Math.max(b/10,0),1),M=f>.3;this.estimation_={heartRate:r,confidence:f,isStable:M,snr:b,signalQuality:f*100},this.currentPulseRate=r,(t=this.onPulseRateUpdate)==null||t.call(this,this.currentPulseRate),this.log(`Estimated HR: ${r.toFixed(1)} BPM, SNR: ${b.toFixed(2)}`)}}catch(s){console.warn("Failed to process signal:",s)}}getHeartRate(t,s){const n=this.timeWindow,i=5,u=t.length/s,l=Math.min(n,Math.max(i,u)),g=this.stride,p=this.lb,d=this.ub,c=this.hrRes,o=Math.round(l*s),x=Math.round(g*s);if(t.length<o)return null;const r=[];for(let e=0;e<=t.length-o;e+=x)r.push(e);if(r.length===0)return null;const b=[];for(let e=p;e<=d;e+=c)b.push(e);const f=b.map(e=>e/60);for(let e=0;e<t.length;e++);const M=[];for(let e=0;e<f.length;e++)M.push(new Array(r.length).fill(0));for(let e=0;e<r.length;e++){const m=r[e],R=m+o;for(let a=0;a<f.length;a++){const _=f[a];let w=0,S=0;for(let v=m;v<R;v++){const D=(v+1)/s,E=-2*Math.PI*_*D,$=t[v];w+=$*Math.cos(E),S+=$*Math.sin(E)}w/=s,S/=s;const W=w*w+S*S;M[a][e]=W}}for(let e=0;e<r.length;e++){let m=0;for(let a=0;a<f.length;a++)m+=M[a][e];const R=m/f.length;if(R>0)for(let a=0;a<f.length;a++)M[a][e]/=R}const A=Math.round(6/c)+1,N=new Array(A).fill(1/A),P=[];for(let e=0;e<f.length;e++)P.push(new Array(r.length).fill(0));for(let e=0;e<r.length;e++){const m=M.map(a=>a[e]),R=this.convolve(m,N);for(let a=0;a<f.length;a++)P[a][e]=R[a]}const B=[];for(let e=0;e<r.length;e++){let m=-1,R=-1;for(let a=0;a<f.length;a++)P[a][e]>m&&(m=P[a][e],R=a);B.push(b[R])}const F=B.filter(e=>!isNaN(e));return F.length===0?null:{heartRate:F.reduce((e,m)=>e+m,0)/F.length,heartRatePerWindow:B}}convolve(t,s){const n=new Array(t.length).fill(0),i=s.length,u=Math.floor(i/2);for(let l=0;l<t.length;l++){let g=0;for(let p=0;p<i;p++){const d=l-u+p;let c=0;if(d>=0&&d<t.length)c=t[d];else{let o=d;for(;o<0||o>=t.length;)o<0&&(o=-o),o>=t.length&&(o=2*t.length-2-o);c=t[o]}g+=c*s[i-1-p]}n[l]=g}return n}calculateSNR(t){if(t.length===0)return 0;const s=t.reduce((u,l)=>u+l,0)/t.length,n=t.reduce((u,l)=>u+Math.pow(l-s,2),0)/t.length,i=Math.sqrt(n);return(Math.max(...t)-Math.min(...t))/(i+1e-4)}updateWithServerResult(t,s,n){var i;this.estimation_={heartRate:Math.round(t),confidence:1,isStable:!0,snr:s,signalQuality:n},this.currentPulseRate=Math.round(t),(i=this.onPulseRateUpdate)==null||i.call(this,this.currentPulseRate)}reset(){this.estimation_=null,this.signalBuffer=[],this.timestamps=[],this.currentPulseRate=0}}export{q as FdaRealtimeEstimator};

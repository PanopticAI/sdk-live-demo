import{J as l,U as n,x as c,d as m}from"./index-bB6-Pi5A.js";var d=Object.defineProperty,g=(a,t,i)=>t in a?d(a,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):a[t]=i,e=(a,t,i)=>g(a,typeof t!="symbol"?t+"":t,i);class f{constructor(t){e(this,"config",{earlyEstimation:!1,minDuration:3,minConfidence:.6,debug:!1}),e(this,"estimation_",null),e(this,"signalBuffer",[]),e(this,"timestamps",[]),e(this,"maxBufferSize",512),e(this,"welchArray",new Array(300).fill(0)),e(this,"welchCount",210),e(this,"welchBufferSize",300),e(this,"isInitialized",!1),e(this,"isInitializing",!1),e(this,"modelPath","models/me-rppg/model.onnx"),e(this,"statePath","models/me-rppg/state.json"),e(this,"welchPath","models/me-rppg/welch_psd.onnx"),e(this,"hrPath","models/me-rppg/get_hr.onnx"),e(this,"lambda",1),e(this,"workerFactory",()=>new Worker(new URL("/sdk-live-demo/realtime-demo/assets/V76HjiDT-DY_Zenwo.js",import.meta.url),{type:"module"})),e(this,"workerPool"),e(this,"lastProcessTime",0),e(this,"maxProcessFrameRate",30),e(this,"minProcessInterval",1e3/this.maxProcessFrameRate),e(this,"processTimer",null),e(this,"pendingFrame",null),e(this,"isProcessing",!1),t&&(this.configure(t),t.modelPath&&(this.modelPath=t.modelPath),t.statePath&&(this.statePath=t.statePath),t.welchPath&&(this.welchPath=t.welchPath),t.hrPath&&(this.hrPath=t.hrPath),t.lambda!==void 0&&(this.lambda=t.lambda)),this.workerPool=l(this.workerFactory,m,"MeRppgWorker",3e4,1),this.initializeModels()}log(t,...i){this.config.debug&&console.log(`[MeRppgRealtimeEstimator] ${t}`,...i)}resolveUrl(t){if(t.startsWith("http")||t.startsWith("/")||!n.loadModelsFromRoot){const i=new URL(document.baseURI);return new URL(t,i).href}return`/${t}`}async initializeModels(){if(!(this.isInitializing||this.isInitialized)){this.isInitializing=!0;try{this.log("Initializing ONNX models in worker...");const t={type:"init",modelPath:this.resolveUrl(this.modelPath),statePath:this.resolveUrl(this.statePath),welchPath:this.resolveUrl(this.welchPath),hrPath:this.resolveUrl(this.hrPath),lambda:this.lambda};this.isInitialized=!0,this.log("Initialization request sent to worker"),this.workerPool.callWorker(t).catch(i=>{this.config.debug&&console.error("Failed to initialize worker:",i),this.isInitialized=!1})}catch(t){this.config.debug&&console.error("Failed to initialize ONNX models:",t),this.isInitialized=!1}finally{this.isInitializing=!1}}}get estimation(){return this.estimation_}get signalData(){return this.signalBuffer.length===0?null:{values:[...this.signalBuffer],timestamps:[...this.timestamps],sampleRate:this.getSampleRate()}}configure(t){t&&(this.config={...this.config,...t})}processFrame(t,i,s,h){i!==c.Idle&&(!h||!h.face||(this.pendingFrame={videoFrame:t,roi:h.face},this.processTimer===null&&!this.isProcessing&&this.startProcessTimer()))}startProcessTimer(){this.processTimer=window.setInterval(()=>{if(!this.isProcessing&&this.pendingFrame){const t=this.pendingFrame;this.pendingFrame=null,this.isProcessing=!0,this.processFrameAsync(t.videoFrame,t.roi).finally(()=>{this.isProcessing=!1})}},this.minProcessInterval)}async processFrameAsync(t,i){if(this.isInitialized)try{const s=await i.imageData;if(!s)return;const h=Date.now()/1e3,o={type:"process",imageData:s,timestamp:h};this.workerPool.callWorker(o,{transfer:[]}).then(r=>{r.type==="processed"&&r.bvpValue!==void 0?(this.signalBuffer.push(r.bvpValue),this.timestamps.push(Date.now()),this.signalBuffer.length>this.maxBufferSize&&(this.signalBuffer.shift(),this.timestamps.shift()),this.welchArray.push(r.bvpValue),this.welchArray.length>this.welchBufferSize&&this.welchArray.shift(),this.welchCount++,this.welchCount>=300&&(this.processWelch(),this.welchCount=270)):r.type==="error"&&this.config.debug&&console.warn("Worker error:",r.error)}).catch(r=>{this.config.debug&&console.warn("Failed to process frame in worker:",r)})}catch(s){this.config.debug&&console.warn("Failed to process frame:",s)}}async processWelch(){var t;if(this.isInitialized)try{const i={type:"welch",welchArray:[...this.welchArray],timestamps:[...this.timestamps]},s=await this.workerPool.callWorker(i);s.type==="welch"&&s.heartRate!==void 0?(this.estimation_={heartRate:s.heartRate,confidence:s.confidence||0,isStable:s.isStable||!1,signalQuality:s.signalQuality||0},this.log(`Estimated HR: ${s.heartRate.toFixed(1)} BPM, Confidence: ${(t=s.confidence)==null?void 0:t.toFixed(2)}, Stable: ${s.isStable}`)):s.type==="error"&&this.config.debug&&console.warn("Worker error during Welch processing:",s.error)}catch(i){this.config.debug&&console.warn("Failed to process Welch:",i)}}getSampleRate(){if(this.timestamps.length<2)return 30;const t=this.timestamps[this.timestamps.length-1]-this.timestamps[0];return(this.timestamps.length-1)*1e3/t}updateWithServerResult(t,i,s){this.estimation_={heartRate:Math.round(t),confidence:1,isStable:!0,snr:i,signalQuality:s}}reset(){if(this.estimation_=null,this.signalBuffer=[],this.timestamps=[],this.welchArray=new Array(300).fill(0),this.welchCount=210,this.lastProcessTime=0,this.pendingFrame=null,this.isProcessing=!1,this.processTimer!==null&&(clearInterval(this.processTimer),this.processTimer=null),this.isInitialized){const t={type:"reset",statePath:this.statePath};this.workerPool.callWorker(t).catch(i=>{this.config.debug&&console.warn("Failed to reset worker:",i)})}}setLambda(t){this.lambda=t}dispose(){this.processTimer&&clearInterval(this.processTimer),this.workerPool.terminateAll()}}export{f as MeRppgRealtimeEstimator};

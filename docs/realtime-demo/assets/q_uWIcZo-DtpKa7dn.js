import{U as d,x as u}from"./index-BDEnCT1Q.js";var f=Object.defineProperty,g=(l,t,s)=>t in l?f(l,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):l[t]=s,r=(l,t,s)=>g(l,typeof t!="symbol"?t+"":t,s);class p{constructor(t){r(this,"config",{earlyEstimation:!1,minDuration:10,minConfidence:.6,debug:!1}),r(this,"estimation_",null),r(this,"signalBuffer",[]),r(this,"timestamps",[]),r(this,"maxBufferSize",450),r(this,"currentPulseRate",0),r(this,"onPulseRateUpdate"),r(this,"wasmModule",null),r(this,"wasmCore",null),r(this,"wasmLoadPromise",null),t&&this.configure(t)}log(t,...s){this.config.debug&&console.log(`[FdaRealtimeEstimator] ${t}`,...s)}resolveModelPath(t){return t.startsWith("http")||t.startsWith("/")||!d.loadModelsFromRoot?t:`/${t}`}async ensureWasmLoaded(){if(!(this.wasmModule&&this.wasmCore))return this.wasmLoadPromise?this.wasmLoadPromise:(this.wasmLoadPromise=(async()=>{try{this.log("Loading WASM module..."),console.log("[FdaRealtimeEstimator] Starting WASM import...");const t=this.resolveModelPath("models/fda/fda-estimator.js");console.log("[FdaRealtimeEstimator] Loading script from:",t),await new Promise((s,a)=>{const e=document.createElement("script");e.src=t,e.onload=()=>{if(console.log("[FdaRealtimeEstimator] Script loaded successfully"),typeof window.createFdaEstimator=="function"){const i=window.createFdaEstimator;i({locateFile:o=>(console.log("[FdaRealtimeEstimator] locateFile called for:",o),o.endsWith(".wasm")?this.resolveModelPath("models/fda/fda-estimator.wasm"):o)}).then(o=>{this.wasmModule=o,console.log("[FdaRealtimeEstimator] WASM loaded via script tag"),s()}).catch(o=>{console.error("[FdaRealtimeEstimator] Failed to initialize WASM module:",o),a(o)})}else a(new Error("createFdaEstimator function not found after script load"))},e.onerror=()=>a(new Error("Failed to load WASM script")),document.head.appendChild(e)}),console.log("[FdaRealtimeEstimator] WASM module instance:",this.wasmModule),console.log("[FdaRealtimeEstimator] Module instance keys:",Object.keys(this.wasmModule||{})),this.wasmModule&&(this.wasmCore=new this.wasmModule.FdaEstimatorCore,console.log("[FdaRealtimeEstimator] WASM core created:",this.wasmCore)),this.log("WASM module loaded successfully")}catch(t){throw console.error("[FdaRealtimeEstimator] Failed to load WASM module:",t),t}})(),this.wasmLoadPromise)}get estimation(){return this.estimation_}get signalData(){return this.signalBuffer.length===0?null:{values:[...this.signalBuffer],timestamps:[...this.timestamps],sampleRate:this.getSampleRate()}}configure(t){t&&(this.config={...this.config,...t})}processFrame(t,s,a,e){s!==u.Idle&&(!e||!e.face||this.processFrameAsync(t,e.face))}async processFrameAsync(t,s){var a;try{await this.ensureWasmLoaded();const e=await this.extractRealPPGSignal(t,s);if(e!==null&&this.wasmCore&&(this.signalBuffer.push(e),this.timestamps.push(Date.now()),this.signalBuffer.length>this.maxBufferSize&&(this.signalBuffer.shift(),this.timestamps.shift()),this.wasmCore.addSample(e,Date.now()),this.wasmCore.hasEnoughData())){const i=this.wasmCore.processSignal();i.heartRate>0&&(this.estimation_={heartRate:i.heartRate,confidence:i.confidence,isStable:i.isStable,snr:i.snr,signalQuality:i.confidence*100},this.currentPulseRate=i.heartRate,(a=this.onPulseRateUpdate)==null||a.call(this,this.currentPulseRate),this.log(`Estimated HR: ${i.heartRate.toFixed(1)} BPM, SNR: ${i.snr.toFixed(2)}`))}}catch(e){console.warn("Failed to process frame:",e)}}async extractRealPPGSignal(t,s){try{const a=await s.imageData;if(!a)return null;const e=a.data;let i=0,o=0,n=0;for(let m=0;m<e.length;m+=4)i+=e[m+1],o+=e[m+2],n++;if(n===0)return null;const h=i/n,c=o/n;return c<1?h:h/c}catch(a){return console.warn("Failed to extract PPG signal:",a),null}}getSampleRate(){if(this.timestamps.length<2)return 30;const t=this.timestamps[this.timestamps.length-1]-this.timestamps[0];return(this.timestamps.length-1)*1e3/t}updateWithServerResult(t,s,a){var e;this.estimation_={heartRate:Math.round(t),confidence:1,isStable:!0,snr:s,signalQuality:a},this.currentPulseRate=Math.round(t),(e=this.onPulseRateUpdate)==null||e.call(this,this.currentPulseRate)}reset(){this.estimation_=null,this.signalBuffer=[],this.timestamps=[],this.currentPulseRate=0,this.wasmCore&&this.wasmCore.reset()}}export{p as FdaRealtimeEstimator};
